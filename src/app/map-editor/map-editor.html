<div class="container-fluid py-3" style="max-height: calc(100vh - 230px); overflow-y: auto;">
  <!-- Status Messages -->
  @if (sendingStatus() === 'success') {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle"></i> Map sent successfully!
    </div>
  }
  
  @if (sendingStatus() === 'error' && errorMessage()) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-circle"></i> {{ errorMessage() }}
    </div>
  }
  
  @if (uploadingFile()) {
    <div class="alert alert-info" role="alert">
      <span class="spinner-border spinner-border-sm me-2"></span>
      Loading file...
    </div>
  }

  @if (!currentMap()) {
    <!-- Empty State -->
    <div class="card text-center py-5">
      <div class="card-body">
        <i class="fas fa-map fa-3x text-muted mb-3"></i>
        <h5 class="card-title">No Map Loaded</h5>
        <p class="card-text text-muted">
          Create a new map or upload an existing JSON file to get started.
        </p>
      </div>
    </div>
  }

  @if (currentMap(); as map) {
    <!-- Map Information Card -->
    <div class="card mb-3" style="margin-top: 1rem;">
      <div class="card-header">
        <h5 class="mb-0">
          <button 
            class="btn btn-link text-decoration-none text-dark w-100 text-start p-0" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#mapInfoCollapse" 
            aria-expanded="false" 
            aria-controls="mapInfoCollapse">
            <i class="fas fa-info-circle"></i> Map Information
          </button>
        </h5>
      </div>
      <div id="mapInfoCollapse" class="collapse">
        <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="platformNumber" class="form-label">Platform Number *</label>
            <input 
              type="number" 
              id="platformNumber"
              class="form-control" 
              [(ngModel)]="map.PlatformNumber"
              min="1">
          </div>
          <div class="col-md-6">
            <label for="mapName" class="form-label">Map Name *</label>
            <input 
              type="text" 
              id="mapName"
              class="form-control" 
              [(ngModel)]="map.MapName"
              placeholder="Enter map name">
          </div>
          <div class="col-md-4">
            <label for="farmId" class="form-label">Farm ID</label>
            <input 
              type="number" 
              id="farmId"
              class="form-control" 
              [(ngModel)]="map.Map.FarmId"
              min="0">
          </div>
          <div class="col-md-4">
            <label for="siteName" class="form-label">Site Name *</label>
            <input 
              type="text" 
              id="siteName"
              class="form-control" 
              [(ngModel)]="map.Map.SiteName"
              placeholder="Enter site name">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <div class="form-check me-3">
              <input 
                type="checkbox" 
                class="form-check-input" 
                id="isNegative"
                [(ngModel)]="map.Map.IsNegative">
              <label class="form-check-label" for="isNegative">
                Is Negative
              </label>
            </div>
            <div class="form-check">
              <input 
                type="checkbox" 
                class="form-check-input" 
                id="isActive"
                [(ngModel)]="map.IsActive">
              <label class="form-check-label" for="isActive">
                Is Active
              </label>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>

    <!-- Locations Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 flex-grow-1">
          <button 
            class="btn btn-link text-decoration-none text-dark w-100 text-start p-0" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#locationsCollapse" 
            aria-expanded="true" 
            aria-controls="locationsCollapse">
            <i class="fa-solid fa-location-dot"></i> Locations ({{ locations().length }})
          </button>
        </h5>
        <div class="d-flex gap-2">
          <button 
            class="rounded-circle" 
            [ngClass]="{'saved': isActionActive('save_local')}"
            style="width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; background: #28a745; color: white; border: 1px solid white; cursor: pointer;"
            [disabled]="!currentMap()"
            (click)="saveMap()"
            title="Save Map Locally">
            <i class="fas fa-save" style="font-size: 1.2rem;"></i>
          </button>
          <button 
            class="rounded-circle" 
            style="width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; background: #28a745; color: white; border: 1px solid white; cursor: pointer;"
            (click)="addLocation()"
            title="Add Location">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
      <div id="locationsCollapse" class="collapse show">
        <div class="card-body">
        @if (locations().length === 0) {
          <div class="text-center text-muted py-4">
            <i class="fas fa-map-pin fa-2x mb-2"></i>
            <p>No locations added yet. Click the green button to add a location.</p>
          </div>
        } @else {
          <div class="accordion" id="locationsAccordion">
            @for (location of locations(); track location.Index; let i = $index) {
              <div class="accordion-item">
                <h2 class="accordion-header" [id]="'heading' + i">
                  <button 
                    class="accordion-button collapsed" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    [attr.data-bs-target]="'#collapse' + i" 
                    aria-expanded="false" 
                    [attr.aria-controls]="'collapse' + i">
                    <strong>#{{ location.Index }}</strong> &nbsp;-&nbsp; {{ getLocationTypeName(location.Location.Type) }}
                  </button>
                </h2>
                <div 
                  [id]="'collapse' + i" 
                  class="accordion-collapse collapse" 
                  [attr.aria-labelledby]="'heading' + i" 
                  data-bs-parent="#locationsAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <!-- Type -->
                      <div class="col-6">
                        <label class="form-label fw-bold">Type</label>
                        <select 
                          class="form-select" 
                          [(ngModel)]="location.Location.Type">
                          <option [value]="LocationType.Unknown">Unknown</option>
                          <option [value]="LocationType.MilkStall">Milk Stall</option>
                          <option [value]="LocationType.Parking">Parking</option>
                          <option [value]="LocationType.BrusherStation">Brusher Station</option>
                          <option [value]="LocationType.DipperStation">Dipper Station</option>
                          <option [value]="LocationType.WashStation">Wash Station</option>
                          <option [value]="LocationType.LeftCup">Left Cup</option>
                          <option [value]="LocationType.RightCup">Right Cup</option>
                        </select>
                      </div>
                      <!-- ID -->
                      <div class="col-6">
                        <label class="form-label fw-bold">ID</label>
                        <input 
                          type="number" 
                          class="form-control" 
                          [(ngModel)]="location.Location.ID"
                          min="0">
                      </div>
                      <!-- X Location -->
                      <div class="col-4">
                        <label class="form-label fw-bold">X</label>
                        <input 
                          type="number" 
                          step="0.001" 
                          class="form-control" 
                          [(ngModel)]="location.XLocationInMeters"
                          (blur)="formatToThreeDecimals(location, 'XLocationInMeters')"
                          placeholder="0.000">
                      </div>
                      <!-- Y Location -->
                      <div class="col-4">
                        <label class="form-label fw-bold">Y</label>
                        <input 
                          type="number" 
                          step="0.001" 
                          class="form-control" 
                          [(ngModel)]="location.YLocationInMeters"
                          (blur)="formatToThreeDecimals(location, 'YLocationInMeters')"
                          placeholder="0.000">
                      </div>
                      <!-- Z Location -->
                      <div class="col-4">
                        <label class="form-label fw-bold">Z</label>
                        <input 
                          type="number" 
                          step="0.001" 
                          class="form-control" 
                          [(ngModel)]="location.ZLocationInMeters"
                          (blur)="formatToThreeDecimals(location, 'ZLocationInMeters')"
                          placeholder="0.000">
                      </div>
                      <!-- Action Buttons -->
                      <div class="col-12">
                        <div style="display: grid; grid-template-columns: 45% calc(25% - 10px) calc(25% - 10px); gap: 0.8rem;">
                          <button 
                            class="btn btn-danger remove-location-btn" 
                            (click)="removeLocation(i)"
                            title="Remove Location">
                            <i class="fas fa-trash"></i>
                          </button>
                          <button 
                            class="btn btn-outline-secondary arrow-btn rounded-circle" 
                            style="height: 4.05rem; width: 4.05rem; padding: 0;"
                            [disabled]="i === 0"
                            (click)="moveLocationUp(i)"
                            title="Move Up">
                            <i class="fas fa-chevron-up"></i>
                          </button>
                          <button 
                            class="btn btn-outline-secondary arrow-btn rounded-circle" 
                            style="height: 4.05rem; width: 4.05rem; padding: 0;"
                            [disabled]="i === locations().length - 1"
                            (click)="moveLocationDown(i)"
                            title="Move Down">
                            <i class="fas fa-chevron-down"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
        </div>
      </div>
    </div>
  }

  <!-- Bottom Toolbar -->
  <div class="fixed-bottom border-top" style="background: #546e7a; padding: 1rem; padding-top: 2rem;">
    <div style="display: flex; gap: 0.5rem; justify-content: center;">
      <button 
        class="footer-btn" 
        [ngClass]="{'done': isActionActive('new_map')}"
        (click)="initializeNewMap()">
        <i class="fas fa-plus" style="font-size: 2rem;"></i>
        <span style="margin-top: 0.5rem;">New<br>Map</span>
      </button>
      <label 
        class="footer-btn" 
        [ngClass]="{'done': isActionActive('upload')}"
        style="margin: 0;">
        <input 
          type="file" 
          accept=".json" 
          (change)="onFileUpload($event)" 
          style="display: none;">
        <i class="fas fa-upload" style="font-size: 2rem;"></i>
        <span style="margin-top: 0.5rem;">Upload<br>JSON</span>
      </label>
      <button 
        class="footer-btn" 
        [ngClass]="{'done': isActionActive('export')}"
        [disabled]="!currentMap()"
        (click)="exportMapAsJson()">
        <i class="fas fa-download" style="font-size: 2rem;"></i>
        <span style="margin-top: 0.5rem;">Export<br>JSON</span>
      </button>
      <button 
        class="footer-btn" 
        [ngClass]="{'done': isActionActive('send')}"
        [disabled]="!currentMap() || sendingStatus() === 'sending'"
        (click)="sendMapToRobot()">
        @if (sendingStatus() !== 'sending') {
          <i class="fas fa-paper-plane" style="font-size: 2rem;"></i>
        }
        @if (sendingStatus() === 'sending') {
          <span class="spinner-border spinner-border-sm" style="font-size: 2rem;"></span>
        }
        <span style="margin-top: 0.5rem;">Send to<br>Robot</span>
      </button>
    </div>
  </div>
</div>
