<div class="min-vh-100 mt-2"  style="background: #607d8b;">
  <div class="container-fluid p-4">

    <!-- Success Messages -->
    @if (commandSent()) {
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        Command sent successfully!
      </div>
    }
    
    @if (stopCommandSent()) {
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        Stop move command sent successfully!
      </div>
    }

    <!-- Device Selection Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0 d-flex align-items-center">
          <i class="fas fa-cog me-2"></i>
          Select Device
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label for="deviceInput" class="form-label">Device Type</label>
            <div class="d-flex gap-2">
              <input
                type="text"
                class="form-control"
                id="deviceInput"
                [value]="getDisplayText()"
                placeholder="Select device type..."
                readonly
                [ngbPopover]="popoverContent"
                #devicePopover="ngbPopover"
                triggers="manual"
                [autoClose]="false"
                (click)="openPopover(); devicePopover.open()"
                placement="bottom-start"
                container="body"
                popoverClass="device-selection-popover"
                style="cursor: pointer; height: 55px; padding: 8px 16px;"
              />
              <button
                class="btn btn-success"
                (click)="sendCommand()"
                [disabled]="!selectedDeviceType()"
                style="min-width: 80px; height: 40px; min-height: 40px; padding: 8px 16px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
              >
                <i class="fas fa-play" style="font-size: 18px;"></i>
                Go
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Popover Content Template -->
    <ng-template #popoverContent>
      <div class="device-selection-dialog" style="width: 90%; margin: auto;">
        <!-- Header -->
        <div class="p-3 border-bottom" style="width: 100%; background: #b0bec5;">
          <h6 class="mb-0 fw-bold text-center" style="font-size: 16px;">{{ getTempDisplayText() }}</h6>
        </div>

        <!-- Device Type Icons Grid - Two Rows -->
        <div class="p-3" style="padding-top: calc(1rem + 12px) !important;">
          <!-- First Row: 3 devices -->
          <div class="d-flex justify-content-center mb-2" style="gap: 0.5rem;">
            @for (device of deviceTypes.slice(0, 3); track device.type) {
              <button
                type="button"
                class="btn btn-outline-secondary d-flex flex-column align-items-center justify-content-center p-2 device-btn"
                [class.active]="isDeviceTypeSelected(device.type)"
                (click)="selectDeviceType(device.type)"
                style="width: 90px; height: 60px; border-width: 2px;"
              >
                <i class="fas {{ device.icon }} fa-lg" style="color: #37474f; margin-top: 1rem;"></i>
                <small style="font-size: 0.75rem; margin-top: 1rem; color: #37474f;">{{ device.label }}</small>
              </button>
            }
          </div>
          
          <!-- Second Row: 2 devices -->
          <div class="d-flex justify-content-center mb-3" style="gap: 0.5rem;">
            @for (device of deviceTypes.slice(3, 5); track device.type) {
              <button
                type="button"
                class="btn btn-outline-secondary d-flex flex-column align-items-center justify-content-center p-2 device-btn"
                [class.active]="isDeviceTypeSelected(device.type)"
                (click)="selectDeviceType(device.type)"
                style="width: 90px; height: 60px; border-width: 2px;"
              >
                <i class="fas {{ device.icon }} fa-lg" style="color: #37474f; margin-top: 1rem;"></i>
                <small style="font-size: 0.75rem; margin-top: 1rem; color: #37474f;">{{ device.label }}</small>
              </button>
            }
          </div>

          <!-- Index Incrementor - Motion Service Style -->
          <div class="mb-3">
            <label class="form-label fw-bold mb-1" style="font-size: 10px; text-align: center; display: block;">Device Index</label>
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <button
                class="rounded-circle"
                style="width: 1.5rem; height: 1.5rem; background: #dc3545; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                (click)="decrementIndex()"
                [disabled]="tempIndex() <= 1"
                [style.opacity]="tempIndex() <= 1 ? '0.5' : '1'"
                [style.cursor]="tempIndex() <= 1 ? 'not-allowed' : 'pointer'"
              >
                <i class="fas fa-minus" style="font-size: 12px;"></i>
              </button>
              <input
                type="number"
                class="form-control text-center"
                [value]="tempIndex()"
                min="1"
                max="10"
                readonly
                style="font-size: 26px; height: 2.25rem; flex: 1;"
              />
              <button
                class="rounded-circle"
                style="width: 1.5rem; height: 1.5rem; background: #28a745; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                (click)="incrementIndex()"
                [disabled]="tempIndex() >= 10"
                [style.opacity]="tempIndex() >= 10 ? '0.5' : '1'"
                [style.cursor]="tempIndex() >= 10 ? 'not-allowed' : 'pointer'"
              >
                <i class="fas fa-plus" style="font-size: 12px;"></i>
              </button>
            </div>
          </div>

          <!-- Action Buttons - Fixed 8rem Width -->
          <div class="d-flex gap-2 justify-content-center">
            <button
              class="btn btn-success"
              style="width: 8rem; height: 2.25rem; border-radius: 1rem; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px;"
              (click)="saveSelection()"
              [disabled]="!tempDeviceType()"
            >
              <i class="fas fa-check" style="font-size: 12px; margin-right: 0.25rem;"></i>
              Save
            </button>
            <button
              class="btn btn-danger"
              style="width: 8rem; height: 2.25rem; border-radius: 1rem; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px;"
              (click)="cancelSelection()"
            >
              <i class="fas fa-times" style="font-size: 12px; margin-right: 0.25rem;"></i>
              Cancel
            </button>
          </div>
        </div>
      </div>
    </ng-template>

    <!-- Actions Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0 d-flex align-items-center">
          <i class="fas fa-tasks me-2"></i>
          Actions
        </h5>
      </div>
      <div class="card-body">
        @if (getDeviceActions().length > 0) {
          <div class="d-flex flex-wrap gap-2 justify-content-center">
            @for (action of getDeviceActions(); track action.taskType) {
              <button
                class="btn btn-primary"
                (click)="sendActionCommand(action.taskType)"
                style="width: 8rem; height: 2.25rem; border-radius: 1rem; padding: 0.5rem !important; display: flex; align-items: center; justify-content: center; font-size: 16px !important; gap: 0.2rem;"
              >
                <i class="fas {{ action.icon }}" style="font-size: 28px !important;"></i>
                {{ action.label }}
              </button>
            }
          </div>
        } @else {
          <div class="text-center text-muted" style="padding: 1rem; font-size: 14px;">
            <i class="fas fa-info-circle me-2"></i>
            Select a device to view available actions
          </div>
        }
      </div>
    </div>

  </div>

  <!-- Footer with Stop Command -->
  <div class="fixed-bottom border-top" style="background: #546e7a; padding: 1rem; padding-right: 2rem;">
    <div class="container-fluid">
      <button
        class="btn btn-danger w-100"
        (click)="sendStopMoveCommand()"
        style="height: 53px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
      >
        <i class="fas fa-stop" style="font-size: 18px;"></i>
        Stop
      </button>
    </div>
  </div>
</div>
